---
title: |
    | Primeira Lista de Exercícios: 
    | Modelos de Demanda com Escolha Discreta
author: "Guilherme Jardim - 2512502"
output: pdf_document
header-includes:
    - \usepackage{caption}
fontsize: 12pt    
---

\captionsetup[table]{labelformat=empty}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1)
library(tidyverse)
library(kableExtra)
library(BLPestimatoR)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

```{r, echo = FALSE, message = FALSE}
data <- read_csv("input/fipefenabrave.csv", col_names = FALSE) %>% 
  rename(ano_ref = X1, marca = X2, modelo = X3, descmodelo = X4,
         preco = X5, quantidade = X6, combustivel = X7, cc = X8, ipi = X9) %>% 
  mutate(cambio = case_when(
                    str_detect(descmodelo, "Aut") ~ "Automatico",
                    str_detect(descmodelo, "Mec") ~ "Mecanico",
                    TRUE ~ NA_character_),
        portas = str_extract(descmodelo, "\\dp") %>% 
                   str_remove("p") %>% 
                   as.numeric()
        )
```

# Questão 1

Se os dados forem usados dessa forma, introduziremos uma distorção em que carros vendidos em grande quantidade e com muitos sub-modelos poderão ter um market-share menor do que carros vendidos em menor quantidade com poucos sub-modelos. Assim, os parâmetros serão estimados com base em quantidades distorcidas e, com isso, as elasticidade-preço da demanda não serão corretamente calculadas. 

De um ponto de vista mais econométrico, estamos introduzindo um erro de medida ao utilizarmos a base desagregada. Seja $q^{*}$ a quantidade de fato vendida para cada sub-modelo, então observamos $q = q^* + v$. Ao contrário do erro de medida clássico (que não gera viés quando está na variável dependente), entretanto, é razoável supor que $v$ é correlacionado com as variáveis independentes (características do carro). Por exemplo, é possível que estejamos sistematicamente subestimando as vendas do sub-modelo mais barato ou do sub-modelo com mais/menos cilindradas. Nesse caso, um viés seria introduzido na estimação do modelo.

Uma alternativa melhor para combinar quantidades e preços seria eleger um sub-modelo representativo para toda a categoria e atribuir a ele a soma de toda a quantidade vendida. Dessa forma, o market-share correspondente estará correto apesar de descartarmos informações relevantes para os sub-modelos e termos uma redução significativa na amostra. Para esse sub-modelo representativo da categoria, atribuiremos o preço mediano da categoria, a moda da variável de combustível, a mediana da variável de cilindradas, a moda do tipo de câmbio e a mediana do número de portas (extraídas da variável de sub-modelo), e o IPI médio. 

```{r, echo = FALSE, message = FALSE}
data <- data %>% 
  group_by(ano_ref, marca, modelo) %>% 
  summarise(preco = median(preco, na.rm = TRUE),
            quantidade = sum(quantidade, na.rm = TRUE),
            combustivel = Mode(combustivel),
            cc = median(cc, na.rm = TRUE),
            cambio = Mode(cambio),
            portas = median(portas, na.rm = TRUE),
            ipi = mean(ipi, na.rm = TRUE))

```


# Questão 2

Essa limitação da base é um problema porque os parâmetros estimados não serão representativos do mercado como um todo, apenas para essa sub-amostra. Essa primeira questão não é tão relevante para o presente trabalho já que o objetivo maior é a estimação de elasticidades e custos para os modelos disponíveis nos dados, com foco menor no impacto para o mercado em sua totalidade.

Outro ponto relevante é que poderíamos esperar que houvesse um viés gerado pela seleção na amostra. Nevo (2001) argumenta que a princípio as estimativas não devem ser viesadas por essa seleção em um caso similar, onde estima um modelo de demanda a partir das 25 marcas mais vendidas de cereais. Para lidarmos com isso na análise, estimaremos os modelos em amostras diferentes: a primeira utilizará os 50 modelos mais vendidos e a segunda utilizará apenas os 30 modelos mais vendidos, para não haver uma redução tão grande no tamanho da amostra. Se os parâmetros estimados forem razoavelmente similares entre as duas estimações, isso nos dará segurança em relação à robustez dos resultados em face de um possível viés gerado pela seleção.

# Questão 3

Essa informação será necessária para a introdução do _outside good_ no modelo, permitindo que consumidores não comprem nenhuma das marcas disponíveis nos dados. Sem isso, um aumento homogêneo dos preços de todos os produtos não altera as quantidades compradas. Seguindo Berry, Levinsohn e Pakes (1995), nossa medida de tamanho de mercado será dada pelo número de domicílios no Brasil a cada ano, disponível na Pesquisa Nacional por Amostra de Domicílios (PNAD) para 2003 a 2009 e 2011 a 2015, no Censo de 2010 e na Pesquisa Nacional por Amostra de Domicílios Contínua Anual (PNADC/A) para 2016. O uso de dados de fontes diferentes é um problema que será mitigado pela inclusão de efeitos fixos de ano na estimação do modelo. A tabela "Estatísticas do Mercado" resume as variáveis relevantes para o mercado como um todo a cada ano.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
## Market size
pnad <- read_csv("input/pnad.csv", skip = 3) %>% 
  filter(!is.na(`...1`)) %>% 
  select(`2003`:`2015`) %>% 
  pivot_longer(`2003`:`2015`) %>% 
  rename(ano_ref = name, domicilios = value) %>% 
  mutate(ano_ref = as.numeric(ano_ref),
         domicilios = as.numeric(domicilios))

censo <- read_csv("input/censo.csv", skip = 3) %>% 
  select(`2010`) %>% 
  pivot_longer(`2010`) %>% 
  rename(ano_ref = name, domicilios = value) %>% 
  mutate(ano_ref = as.numeric(ano_ref),
         domicilios = as.numeric(domicilios))

pnadc <- read_csv("input/pnadc.csv", skip = 3) %>% 
  select(`2016`) %>% 
  pivot_longer(`2016`) %>% 
  rename(ano_ref = name, domicilios = value) %>% 
  mutate(ano_ref = as.numeric(ano_ref),
         domicilios = as.numeric(domicilios) * 1000) %>% 
  filter(!is.na(domicilios))

M <- rbind(pnad, censo) %>% 
  rbind(pnadc) %>% 
  arrange(ano_ref)

## Prepare data for regressions
prepare_df <- function(.data, .M) {
      
  M_ins <- .data %>% 
    group_by(ano_ref) %>% 
    summarise(quantidade = sum(quantidade))
  
  M <- .M %>% 
    full_join(M_ins) %>% 
    mutate(s0 = (domicilios - quantidade)/domicilios) %>% 
    select(-quantidade)

  ## join with data
  df <- .data %>% 
    left_join(M) %>% 
    mutate(s = quantidade/domicilios,
           y = log(s) - log(s0)) %>% 
    rename(ano = ano_ref)

  return(df)
}


data_restricted <- data %>% 
  group_by(ano_ref, marca, modelo) %>% 
  summarise(quantidade = sum(quantidade)) %>% 
  ungroup() %>% 
  arrange(ano_ref, -quantidade) %>% 
  group_by(ano_ref) %>% 
  slice_head(n = 30) %>% 
  select(-quantidade) %>% 
  left_join(data)

df <- prepare_df(data, M)
df_restricted <- prepare_df(data_restricted, M)

```

```{r, echo = FALSE, message = FALSE}
df %>% 
  group_by(Ano = ano) %>% 
  summarise(M = unique(domicilios), Quantidade = sum(quantidade),
            S0 = unique(s0), S = sum(s)) %>% 
  kbl(caption = "Estatísticas do Mercado",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")

```

Note que há um erro de medida no número de domicílios para o ano de 2016, visto que o IBGE só fornece uma aproximação em mil unidades para esse conjunto de dados. Há uma certa divergência entre o ano de 2010 (vindo do Censo) e os demais anos, mas é o único dado disponível para o ano e isso deve ser mitigado pelos efeitos fixos.

Além disso, como o tamanho do mercado entra na estimativa somente através do market-share do _outside good_ (visto que o tamanho de mercado se cancela quando tiramos a diferença $\ln \left(s_{j}\right)-\ln \left(s_{0}\right)$), um possível viés causado pelo erro de medida na variável afetaria somente o intercepto da regressão.


# Questão 4

Para um modelo de demanda logit, estimaremos a seguinte regressão por mínimos quadrados ordinários:

$$
\ln \left(s^m_{j,t}\right)-\ln \left(s_{0,t}\right)= \phi_t + \phi_m + x_{j,t} \beta-\alpha p_{j,t}+\xi_{j,t}
$$
onde $s^m_{j,t}$ é o market-share do produto $j$ da marca $m$ no ano $t$, calculado como a quantidade dividida pelo tamanho do mercado, $s_{0,t}$ é o market-share do _outside good_ no ano $t$, $\phi_t$ é um efeito fixo de ano (controlar para efeitos no mercado como um todo, ex: inflação entre anos), $\phi_m$ é um efeito fixo de marca (seguindo Nevo, 2001), $x_{j,t}$ é um vetor que inclui o tipo de combustível, cilindradas e número de portas do carro $j$ no ano $t$ e $p_{j,t}$ é o preço de $j$ no ano $t$. O tipo de câmbio não foi incluído como controle por causa da preponderância de _missing values_ na variável, que tornou a amostra muito reduzida. Para a variável de tipo de combustível, a categoria omitida é "Diesel".

Como mencionado na Questão 2, estimamos os modelos em amostras diferentes: a primeira considera os 50 modelos mais vendidos e a segunda apenas os 30 modelos mais vendidos. Os resultados são mostrados na tabela "Logit".

```{r, echo = FALSE, message = FALSE, warning = FALSE}
logit <- fixest::feols(y ~ preco + combustivel + cc + portas | ano + marca, data = df, se = "standard")

logit_restricted <- fixest::feols(y ~ preco + combustivel + cc + portas | ano + marca, data = df_restricted, se = "standard")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
modelsummary::modelsummary(list("50 mais vendidos" = logit, 
                                "30 mais vendidos" = logit_restricted),
                           gof_omit = 'DF|Deviance|Log.Lik.|R.*|AIC|BIC|Std.*|FE.*',
                           title = "Logit",
                           stars = TRUE,
                           fmt = "%.4e") %>% 
  kable_styling(latex_options = "HOLD_position")
```

O parâmetro para o preço possui um sinal consistente com a teoria, apesar de ainda não termos lidado com a questão da endogeneidade. Dentre os tipos de combustível, parece não haver uma predileção por nenhum tipo específico, com efeitos não-significativos na demanda para Gasolina e Flex. O número de cilindradas e portas aparecem com coeficientes negativos, o que não parece ser consistente com o que esperamos, mas não-significativos. Uma explicação possível para estarmos encontrando coeficientes com sinal oposto ao esperado seria devido a essas caracteristicas estarem correlacionadas a variáveis não observadas (como o tamanho do carro), gerando um viés de variável omitida. Por fim, os coeficientes mostram que de fato não parece haver um viés gerado pela seleção: os parâmetros estimados são estáveis entre as duas estimações.

# Questão 5

Para lidarmos com a endogeneidade do preço, podemos utilizar a alíquota do IPI como um instrumento para o preço. Para que essa abordagem seja válida, precisamos que duas condições sejam satisfeitas: a condição de relevância e a condição de exclusão. A condição de relevância é testável e pode ser verificada no primeiro estágio da regressão por mínimos quadrados em dois estágios, para que ela seja satisfeita é necessário que haja uma correlação entre a alíquota e o preço, condicional a outras covariadas. A condição de exclusão requer que a alíquota não seja correlacionada com o erro $\xi_{j,t}$. Como o IPI é pago pela indústria no momento da venda do produto e é determinado pelo ano, cilindradas e combustível --- características observadas e incluídas na regressão --- parece razoável acreditar que ele não está relacionado com o termo de erro e afeta a demanda apenas através do seu impacto no preço. De forma equivalente, podemos pensar no IPI como sendo um cost-shifter, é uma variável que desloca apenas a curva de oferta, nos permitindo mapear a curva de demanda através de sua variação.

Assim, estimamos os mesmos modelos da questão anterior, mas instrumentando o preço com a alíquota do IPI. Os resultados são mostrados nas tabelas "Primeiro Estágio: Logit IV" e "Segundo Estágio: Logit IV". Nesse caso, nem o número de portas nem o tipo de câmbio foram incluídos como controles porque a inclusão deles levou a uma redução na amostra que tornou o instrumento fraco para a estimação. Pela mesma questão de instrumentos fracos, não incluímos o efeito fixo de marca, que tornou o primeiro estágio pouco relevante.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
iv <- fixest::feols(preco ~ ipi + combustivel + cc | ano, data = df, se = "standard")

restricted_iv <- fixest::feols(preco ~ ipi + combustivel + cc | ano, data = df_restricted, se = "standard")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
modelsummary::modelsummary(list("50 mais vendidos" = iv, 
                                "30 mais vendidos" = restricted_iv),
                           gof_omit = 'DF|Deviance|Log.Lik.|R.*|AIC|BIC|Std.*|FE.*',
                           title = "Primeiro Estágio: Logit IV",
                           stars = TRUE,
                           fmt = "%.4e") %>% 
  kable_styling(latex_options = "HOLD_position")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
logit_iv <- fixest::feols(y ~ combustivel + cc | ano | preco ~ ipi, data = df, se = "standard")

logit_restricted_iv <- fixest::feols(y ~ combustivel + cc | ano | preco ~ ipi, data = df_restricted, se = "standard")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
modelsummary::modelsummary(list("50 mais vendidos" = logit_iv, 
                                "30 mais vendidos" = logit_restricted_iv),
                           gof_omit = 'DF|Deviance|Log.Lik.|R.*|AIC|BIC|Std.*|FE.*',
                           title = "Segundo Estágio: Logit IV",
                           stars = TRUE,
                           fmt = "%.4e") %>% 
  kable_styling(latex_options = "HOLD_position")
```

No primeiro estágio, observamos uma relação positiva entre o preço e a alíquota do IPI, consistente com o que esperamos se considerarmos que há um repasse do imposto para o preço do automóvel. Para a amostra reduzida, a correlação entre as duas variáveis é não-significativa, o que sugere a necessidade de métodos para lidar com instrumentos fracos, entretanto, iremos desconsiderar essa questão dado que a utilidade desse modelo se limita à robustez para o viés de seleção.

Podemos ver que há uma diferença relevante nos coeficientes entre a estimação por OLS e IV, indicando que nesse caso a endogeneidade parece ser relevante. Como esperado, há um aumento no erro-padrão gerado pelo IV, o que não afeta a significância do coeficiente estimado. Como na estimação anterior, o coeficiente é negativo, em linha com a teoria. Dentre os tipos de combustível, parece haver uma predileção pelo Diesel, com efeitos negativos na demanda para Gasolina e Flex. Dessa vez, o número de cilindradas aparece com um coeficiente positivo, o que está em linha com o esperado. Vemos também que os coeficientes mostram uma estabilidade entre as duas amostras, o que reforça a convicção de que não há um viés de seleção na estimação.

# Questão 6  

Para o modelo Logit, assumimos a função de utilidade do produto $j$ para o consumidor $i$ no ano $t$ dada por:

$$
u_{i j t}=-\alpha p_{j t}+x_{j t} \beta+\xi_{j t}+\epsilon_{i j t}
$$
O consumidor escolherá o produto $j$ que maximiza a sua utilidade. Com $\epsilon_{i j t}$ i.i.d. Gumbel, o market-share do produto $j$ no ano $t$ é computada pela expressão abaixo, onde $J$ é o total de produtos:

$$
s_{j t}=\frac{\exp \left(x_{j t} \beta-\alpha p_{j t}+\xi_{j t}\right)}{1+\sum_{k=1}^{J} \exp \left(x_{k t} \beta-\alpha p_{k t}+\xi_{k t}\right)}
$$


Assim, a elasticidade-preço da demanda para o carro $j$ em relação ao carro $k$ no ano $t$ é dada por:

$$
\eta_{j k t}=\frac{\partial s_{j t} p_{k t}}{\partial p_{k t} s_{j t}}= \begin{cases}-\alpha p_{j t}\left(1-s_{j t}\right) & \text { se } j=k \\ \alpha p_{k t} s_{k t} & \text { c.c. }\end{cases}
$$
Vamos observar o caso em que $t = 2009$ e $j = ``\text{VW Gol}"$, o que corresponde ao modelo mais vendido da amostra, com $\alpha = 1.3637 \times 10^{-4}$. Os resultados para todos os modelos está exposto na tabela "Elasticidade-Preço da Demanda do Gol em relação a: (Logit IV)". No gráfico "Elasticidade e Market-Share (Logit IV)", podemos comparar o valor da elasticidade cruzada (eixo y) com o volume de vendas dos carros (eixo x). Há uma relação positiva e aproximadamente linear entre as duas variáveis, facilmente visível na figura.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
alpha <- 1.3637 * 10^(-4)

elast_logit <- df %>% 
  filter(ano == 2009) %>% 
  mutate(elasticidade = ifelse(modelo == "GOL", 
                              -alpha * preco * (1 - s),
                              alpha * preco * s)
        )
```

\vspace{0.5cm}
```{r, echo = FALSE, message = FALSE}
elast_logit %>% 
  select(ano, marca, modelo, s, preco, elasticidade) %>% 
  kbl(caption = "Elasticidade-Preço da Demanda do Gol em relação a: (Logit IV)",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")

elast_logit %>% 
  filter(modelo != "GOL") %>% 
  ggplot(aes(x = quantidade, y = elasticidade)) +
  ggtitle("Elasticidade e Market-Share (Logit IV)") +
  geom_point() +
  theme_bw()
```


# Questão 7  

Para isso, vamos supor que as firmas estão em um oligopólio de Bertrand-Nash, e que o problema de cada firma $f$ é dado por:

$$
\max_{\{p_j\}_f} \Pi_f = \sum\limits_{j\text{ de }f} (p_j - c_j)q_j
$$
O que gera um sistema de CPOs dado por:
$$
s_j - \sum_r (p_r - c_r)\Delta_{jr} = 0
$$
onde $\Delta_{jr} = \begin{cases}-\frac{\partial s_r}{\partial p_j} & \text { se } j=k \\ 0 & \text { c.c. }\end{cases}$

Logo, os $c_i$ podem ser estimados pela expressão na forma matricial, onde c é o vetor de $c_i$: 
$$
c = p - \Delta^{-1}s
$$


Com base nas estimativas de demanda e elasticidade encontradas no modelo Logit usando IV, os resultados são mostrados na tabela "Custo Marginal dado pelo modelo Logit".
```{r, echo = FALSE, message = FALSE}
J <- nrow(elast_logit)

p <- matrix(elast_logit$preco, nrow = J)
s <- matrix(elast_logit$s, nrow = J)

Delta <- matrix(nrow = J, ncol = J)
for (j in 1:J) {
  
  for (r in 1:J) {
    
    if (j == r) {
      Delta[j, r] <- alpha * s[j] * (1 - s[j])
    }
    else if(elast_logit$marca[j] != elast_logit$marca[r]) {
      Delta[j, r] <- 0
    } else {
      Delta[j, r] <- -alpha * s[r] * s[j]
    }
    
  }
}

c <- c(p - solve(Delta) %*% s)
c_logit <- elast_logit %>% cbind("c" = c)

c_logit %>% 
  mutate(markup = (preco/c) - 1) %>% 
  select(ano, marca, modelo, s, preco, c, markup) %>% 
  kbl(caption = "Custo Marginal dado pelo modelo Logit",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")
```

As estimativas obtidas para o custo marginal são razoáveis se levarmos em conta a simplicidade do modelo. Como vimos, o modelo Logit gera uma estrutura rígida de elasticidades que depende principalmente do market-share de cada produto, não permitindo um senso de proximidade entre opções. Essa limitação é passada diretamente para a estimação dos cursos marginais dado que as elasticidades do modelo são usadas no cálculo do markup. Assim, as estimativas são razoáveis a medida em que nos fornecem alguma noção geral de onde se encontra o custo marginal de cada produto e um possível benchmark para modelos alternativos, porém os valores estimados devem ser encarados com cuidado devido às limitações do Logit. Em particular, a estrutura das elasticidades implica que marcas mais baratas terão um markup maior, o que pode não ser verdade para certos produtos.


# Questão 8  

O modelo original em Berry, Levinsohn e Pakes (1995) usa a seguinte especificação para a utilidade, permitindo coeficientes aleatórios para todas as características $x_{j t}$:
$$
u_{i j t}=x_{j t} \bar{\beta}+\xi_{j t}+\alpha \ln \left(y_{i}-p_{j}\right)+\sum_{k} \sigma_{k} x_{j t k} v_{i k}+\epsilon_{i j t}
$$

Como não possuímos os dados de renda por consumidores, vamos introduzir um coeficiente aleatório também no preço, com $\alpha_i p_j$ no lugar de $\alpha \ln \left(y_{i}-p_{j}\right)$.

Os instrumentos utilizados nesse caso serão o IPI, como nos modelos anteriores, e os instrumentos sugeridos no modelo original: a soma das características
(cilindradas, proporção dos automóveis à Gasolina e Flex) entre outros modelos da mesma marca e entre os bens de outras marcas. Consideramos que todas essas características $x_{j t}$ são exógenas.

Além disso, ao invés dos efeitos fixos de ano, vamos considerar que cada ano corresponde a um mercado diferente, e seguiremos sem efeitos fixos de marca, também como no artigo original.

Os resultados são mostrados nas tabelas "BLP - Coeficientes Lineares" e "BLP - Coeficientes Aleatórios".

```{r, include = FALSE, message = FALSE}
J <- nrow(df)

Z <- matrix(data = 0, nrow = J, ncol = 6)
for (j in 1:J) {
  
  for (r in 1:J) {
    
    if (df$modelo[j] == df$modelo[r]) {
      next
    }
    else if(df$marca[j] == df$marca[r]) {
      Z[j, 1] <- Z[j, 1] + (df$combustivel[r] == "Flex")
      Z[j, 2] <- Z[j, 2] + (df$combustivel[r] == "Gasolina")
      Z[j, 3] <- Z[j, 3] + df$cc[r]
    } else if(df$marca[j] != df$marca[r]) {
      Z[j, 4] <- Z[j, 4] + (df$combustivel[r] == "Flex")
      Z[j, 5] <- Z[j, 5] + (df$combustivel[r] == "Gasolina")
      Z[j, 6] <- Z[j, 6] + df$cc[r]
    }
    
  }
}

df_blp <- df %>% cbind(Z %>% as.data.frame())

model <- as.formula("s ~ preco + combustivel + cc |
    0 + combustivel + cc |
    preco + combustivel + cc |
    0 + ipi + V1 + V2 + V3 + V4 + V5 + V6")


blp_data <- BLP_data(model, 
                     market_identifier = "ano",
                     product_identifier = "modelo",
                     productData = df_blp,
                     integration_method = "MLHS",
                     integration_seed = 8,
                     integration_accuracy = 50)

blp_estimate <- estimateBLP(blp_data,
                            solver_method = "BFGS", 
                            solver_maxit = 1000, 
                            solver_reltol = 1e-6,
                            standardError = "homoskedastic",
                            printLevel = 1)

(blp_summ <- summary(blp_estimate))
```

```{r, echo = FALSE, message = FALSE}
tibble(blp_summ$LinCoefficients) %>% 
  cbind(" " = c("Intercepto", "preco", 
          "combustivelFlex", "combustivelGasolina", "cc")) %>% 
  select(` `,
         Estimativa = Estimate, 
         `Erro-Padrão` = `Std. Error`, 
         `Estatística-t` = `t value`, 
         `P-valor` = `Pr(>|t|)`) %>% 
  kbl(caption = "BLP - Coeficientes Lineares",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")

tibble(blp_summ$RcCoefficients) %>% 
  cbind(" " = c("Intercepto", "preco", 
          "combustivelFlex", "combustivelGasolina", "cc")) %>% 
  select(` `,
         Estimativa = Estimate, 
         `Erro-Padrão` = `Std. Error`, 
         `Estatística-t` = `t value`, 
         `P-valor` = `Pr(>|t|)`) %>% 
  kbl(caption = "BLP - Coeficientes Aleatórios",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")

```

Focando na primeira tabela, temos que, como nas estimações anteriores, o coeficiente do preço é negativo, em linha com a teoria. Os outros coeficientes se mostram não-significativos, o que indica que na média os consumidores não são afetados por uma diferença no número de cilindradas ou em carros Flex/à Gasolina ao invés de Diesel, ao contrário do que esperaríamos.

O grande diferencial do modelo BLP aparece na segunda tabela. O coeficiente positivo para o preço indica que há uma dispersão estatisticamente significativa entre os parâmetros de "gosto" dos consumidores em relação ao preço na demanda pelos produtos, ou seja, há de fato uma heterogeneidade entre os consumidores no "peso" que eles atribuem ao preço do carro em sua decisão de compra. Para as outras variáveis do modelo, apesar de a princípio esperarmos algo similar, não parece ser o caso: os parâmetros estimados não são estatisticamente diferentes de zero, o que sugere que não há dispersão nos "gostos" para as características de tipo de combustível e cilindradas.


# Questão 9  

Para o modelo BLP, a elasticidade-preço da demanda passa a ser dada por (Nevo, 2000): 
$$
\eta_{j k t}=\frac{\partial s_{j t} p_{k t}}{\partial p_{k t} s_{j t}}= \begin{cases}-\frac{p_{j t}}{s_{j t}} \int \alpha_{i} s_{i j t}\left(1-s_{i j t}\right) d \hat{P}_{D}^{*}(D) d P_{\nu}^{*}(v) & \text { se } j=k \\ \frac{p_{k t}}{s_{j t}} \int \alpha_{i} s_{i j t} s_{i k t} d \hat{P}_{D}^{*}(D) d P_{\nu}^{*}(v) & \text { c.c. }\end{cases}
$$

Logo, precisaremos estimar essa integral para computar as elasticidades.

Vamos novamente observar o caso em que $t = 2009$ e $j = ``\text{VW Gol}"$, o que corresponde ao modelo mais vendido da amostra. Os resultados para todos os modelos está exposto na tabela "Elasticidade-Preço da Demanda do Gol em relação a: (BLP)". No gráfico "Elasticidade e Market-Share (BLP)", podemos comparar o valor da elasticidade cruzada (eixo y) com o volume de vendas dos carros (eixo x). Não parece haver uma relação clara entre as duas variáveis, havendo outliers notáveis, bem diferente do previsto pelo modelo Logit.

```{r, include = FALSE, message = FALSE, warning = FALSE}
# extract parameters from output
theta1_price <- blp_estimate$theta_lin["preco", ]

theta2 <- matrix(NA, nrow = 5, ncol = 1)
colnames(theta2) <- c("unobs_sd")
rownames(theta2) <- c("(Intercept)", "preco", "combustivelFlex", "combustivelGasolina", "cc")
for (i in 1:5) {
  theta2[blp_estimate$indices[i, 1], blp_estimate$indices[i, 2]] <- blp_estimate$theta_rc[i]
}


delta_data <- data.frame(
  "modelo" = blp_data$parameters$product_id,
  "ano" = blp_data$parameters$market_id_char_in,
  "startingGuessesDelta" = blp_estimate$delta
)

blp_data <- update_BLP_data(
  data_update = delta_data,
  blp_data = blp_data
)

shareObj <- getShareInfo(
  blp_data = blp_data,
  par_theta2 = theta2,
  printLevel = 1
)

blp_elast <- get_elasticities(
  blp_data = blp_data,
  share_info = shareObj,
  theta_lin = theta1_price,
  variable = "preco",
  market = "2009"
)


elast_blp <- df %>% 
  filter(ano == 2009) %>% 
  cbind("elasticidade" = tibble(elasticidade = blp_elast["GOL", ]))
```

\vspace{0.5cm}
```{r, echo = FALSE, message = FALSE}
elast_blp %>% 
  select(ano, marca, modelo, s, preco, elasticidade) %>% 
  kbl(caption = "Elasticidade-Preço da Demanda do Gol em relação a: (BLP)",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")

elast_blp %>% 
  filter(modelo != "GOL") %>% 
  ggplot(aes(x = quantidade, y = elasticidade)) +
  ggtitle("Elasticidade e Market-Share (BLP)") +
  geom_point() +
  theme_bw()
```

Para a estimação do custo marginal, iremos proceder como na Questão 7, mas utilizando as elasticidades geradas pelo modelo BLP. Os resultados são mostrados na tabela "Custo Marginal dado pelo modelo BLP".

```{r, echo = FALSE, message = FALSE}
J <- nrow(elast_blp)

p <- matrix(elast_blp$preco, nrow = J)
s <- matrix(elast_blp$s, nrow = J)

Delta <- matrix(nrow = J, ncol = J)
for (j in 1:J) {
  
  for (r in 1:J) {
    
    if(elast_blp$marca[j] != elast_blp$marca[r]) {
      Delta[j, r] <- 0
    } else {
      Delta[j, r] <- -blp_elast[j, r] * s[j] / p[r]
    }
    
  }
}

c <- c(p - solve(Delta) %*% s)
c_blp <- elast_blp %>% cbind("c" = c)

c_blp %>% 
  mutate(markup = (preco/c) - 1) %>% 
  select(ano, marca, modelo, s, preco, c, markup) %>% 
  kbl(caption = "Custo Marginal dado pelo modelo BLP",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")
```

As estimativas obtidas para o custo marginal diferem bastante das dadas pelo modelo Logit. Para a maioria dos carros, o BLP gera um markup menor do que o observado no Logit, entretanto, carros como o "Mitsubishi Pajero" apresentam um markup maior do que outros. A diferença principal é que a estrutura das elasticidades gerada pelo BLP não implica que marcas mais baratas terão um markup maior, como no caso do Logit.

Entretanto, não é tão claro que o método BLP tenha gerado respostas mais adequadas apesar das limitações do modelo Logit. Observando as Elasticidades-Preço da Demanda do Gol estimadas pelo BLP, vemos que carros como o "GM Captiva" e o "Mitsubishi Pajero" apresentam as elaticidades cruzadas mais altas apesar de não serem carros similares ao Gol: se tratam de carros significativamente mais caros e de tamanho bem maior. Carros similares ao Gol como o "GM Classic", "GM Celta" e o "Renault Logan" apresentam elasticidades maiores que as dadas pelo modelo Logit (como esperado), mas bem menores do que os dois carros citados anteriormente. Uma possível explicação para esse resultado inesperado é que possuímos poucas características observadas para os carros. Como o modelo BLP gera um senso de proximidade entre os produtos com base nos coeficientes aleatórios introduzidos nessas características $x_{j,t}$, a quantidade reduzida desses regressores pode prejudicar o cálculo dessas elasticidades cruzadas, gerando padrões de substituição não tão realistas.


\vspace{1cm}  

# Referências
- Berry, S., Levinsohn, J., & Pakes, A. (1995). Automobile prices in market equilibrium. Econometrica, 841-890.

- Nevo, A. (2000). A practitioner's guide to estimation of random‐coefficients logit models of demand. Journal of Economics & Management Strategy, 9(4), 513-548.

- Nevo, A. (2001). Measuring market power in the ready‐to‐eat cereal industry. Econometrica, 69(2), 307-342.
